# 要件文書

## 概要

マルチプレイヤー対応のブラックジャックWebアプリケーション。複数のプレイヤーが同時に参加でき、複数のゲームルームで並行してゲームを進行できるリアルタイムゲームシステム。

## 用語集

- **System**: ブラックジャックマルチプレイヤーシステム
- **Player**: ゲームに参加するユーザー
- **Room**: ブラックジャックゲームが行われる仮想空間
- **Dealer**: ゲーム進行を自動で行うシステムコンポーネント
- **Game_Session**: 一回のブラックジャックゲームの開始から終了まで
- **Hand**: プレイヤーまたはディーラーが持つカードの組み合わせ
- **Deck**: 52枚のトランプカード一組
- **Chip**: ゲーム内で使用される仮想通貨単位（$1, $5, $25, $100, $500, $1000, $5000）
- **Bet**: プレイヤーがゲーム開始前に賭けるチップの額
- **Balance**: プレイヤーが保有するチップの総額
- **Payout**: 勝利時にプレイヤーが受け取るチップの額

## 要件

### 要件 1: プレイヤー参加管理

**ユーザーストーリー:** プレイヤーとして、リンクにアクセスして参加ボタンを押すことで、ブラックジャックゲームに参加したい。

#### 受入基準

1. WHEN プレイヤーがルームリンクにアクセスする THEN THE System SHALL ルーム参加インターフェースを表示する
2. WHEN プレイヤーが参加ボタンをクリックする THEN THE System SHALL プレイヤーをルームに追加し参加者リストを更新する
3. WHEN プレイヤーがルームに参加する THEN THE System SHALL 他の参加者にリアルタイムで参加通知を送信する
4. WHEN プレイヤーがブラウザを閉じるまたは接続が切断される THEN THE System SHALL プレイヤーをルームから除外し他の参加者に通知する

### 要件 2: ゲーム開始制御

**ユーザーストーリー:** プレイヤーとして、一人以上の参加者がいる状態で開始ボタンを押すことで、ゲームを開始したい。

#### 受入基準

1. WHEN ルームに一人以上のプレイヤーが参加している THEN THE System SHALL ゲーム開始ボタンを有効化する
2. WHEN プレイヤーがゲーム開始ボタンをクリックする THEN THE System SHALL 新しいGame_Sessionを作成し全参加者に開始通知を送信する
3. WHEN Game_Sessionが開始される THEN THE System SHALL 新しいDeckをシャッフルし各プレイヤーに2枚のカードを配布する
4. WHEN ゲームが進行中である THEN THE System SHALL 新しいプレイヤーの参加を一時的に無効化する

### 要件 3: ディーラー自動化

**ユーザーストーリー:** システム管理者として、ディーラーが自動で動作することで、人的介入なしにゲームが進行されることを望む。

#### 受入基準

1. WHEN 全プレイヤーのターンが終了する THEN THE Dealer SHALL 自動的にカードを引き始める
2. WHEN Dealerの手札の合計が16以下である THEN THE Dealer SHALL 追加のカードを引く
3. WHEN Dealerの手札の合計が17以上である THEN THE Dealer SHALL カードを引くのを停止する
4. WHEN Dealerのターンが終了する THEN THE System SHALL 勝敗判定を実行し結果を全プレイヤーに送信する
5. WHEN ゲームが終了する THEN THE System SHALL 5秒後に新しいゲームの開始を可能にする

### 要件 4: マルチルーム管理

**ユーザーストーリー:** プレイヤーとして、複数のブラックジャックルームから選択して参加することで、同時進行する複数のゲームを楽しみたい。

#### 受入基準

1. THE System SHALL 最低3つの独立したルーム（ルーム1、ルーム2、ルーム3）を同時に運用する
2. WHEN プレイヤーがルーム選択画面にアクセスする THEN THE System SHALL 利用可能なルーム一覧と各ルームの参加者数を表示する
3. WHEN 複数のルームで同時にゲームが進行している THEN THE System SHALL 各ルームの状態を独立して管理する
4. WHEN プレイヤーが一つのルームに参加している THEN THE System SHALL そのプレイヤーが他のルームに同時参加することを防止する

### 要件 5: リアルタイム通信

**ユーザーストーリー:** プレイヤーとして、他のプレイヤーのアクションやゲーム状態の変化をリアルタイムで確認したい。

#### 受入基準

1. WHEN プレイヤーがアクション（ヒット、スタンド等）を実行する THEN THE System SHALL 200ms以内に他の全参加者に状態更新を送信する
2. WHEN ゲーム状態が変化する THEN THE System SHALL WebSocketまたはServer-Sent Eventsを使用してリアルタイム通信を実行する
3. WHEN 接続が一時的に切断される THEN THE System SHALL 自動再接続を試行し状態を同期する
4. WHEN 通信エラーが発生する THEN THE System SHALL エラーメッセージを表示し適切な復旧手順を提供する

### 要件 6: ゲームロジック実装

**ユーザーストーリー:** プレイヤーとして、標準的なブラックジャックルールに従ってゲームをプレイしたい。

#### 受入基準

1. WHEN プレイヤーの手札の合計が21を超える THEN THE System SHALL そのプレイヤーをバストとして処理する
2. WHEN プレイヤーがヒットを選択する THEN THE System SHALL Deckから1枚のカードを引き手札に追加する
3. WHEN プレイヤーがスタンドを選択する THEN THE System SHALL そのプレイヤーのターンを終了し次のプレイヤーまたはディーラーに移行する
4. WHEN エースが手札にある THEN THE System SHALL 手札の合計が21を超えない場合は11として、超える場合は1として計算する
5. WHEN 勝敗判定が実行される THEN THE System SHALL ブラックジャック標準ルールに従って各プレイヤーの勝敗を決定する

### 要件 7: ユーザーインターフェース

**ユーザーストーリー:** プレイヤーとして、直感的で使いやすいWebインターフェースでゲームをプレイしたい。

#### 受入基準

1. WHEN プレイヤーがゲーム画面にアクセスする THEN THE System SHALL 自分の手札、ディーラーの手札、利用可能なアクションボタンを表示する
2. WHEN プレイヤーのターンである THEN THE System SHALL ヒット、スタンドボタンを有効化し視覚的にターンを示す
3. WHEN 他のプレイヤーのターンである THEN THE System SHALL 現在のプレイヤーを視覚的に強調表示する
4. WHEN ゲームが終了する THEN THE System SHALL 勝敗結果を明確に表示し新しいゲーム開始オプションを提供する
5. WHEN モバイルデバイスからアクセスする THEN THE System SHALL レスポンシブデザインで適切に表示する

### 要件 8: データ整合性とセキュリティ

**ユーザーストーリー:** システム管理者として、ゲームデータの整合性が保たれ、不正行為が防止されることを望む。

#### 受入基準

1. WHEN カードが配布される THEN THE System SHALL サーバーサイドでDeckの状態を管理し改ざんを防止する
2. WHEN プレイヤーがアクションを送信する THEN THE System SHALL そのアクションが有効なターンで実行されることを検証する
3. WHEN 複数のプレイヤーが同時にアクションを送信する THEN THE System SHALL 適切な順序でアクションを処理する
4. WHEN ゲーム状態が更新される THEN THE System SHALL 全クライアントの状態同期を保証する

### 要件 9: ベッティングシステム

**ユーザーストーリー:** プレイヤーとして、本物のカジノのようにチップを賭けてゲームをプレイし、勝利時に配当を受け取りたい。

#### 受入基準

1. WHEN プレイヤーがルームに参加する THEN THE System SHALL プレイヤーに初期チップ残高$1,000を付与する
2. WHEN ゲーム開始前である THEN THE System SHALL プレイヤーにベッティングインターフェースを表示する
3. WHEN プレイヤーがベットを配置する THEN THE System SHALL 以下のチップ額のみを受け付ける: $1（白）、$5（赤）、$25（緑）、$100（黒）、$500（紫）、$1,000（オレンジ）、$5,000（茶色）
4. WHEN プレイヤーがベットを配置する THEN THE System SHALL ベット額が最小ベット額$1以上かつプレイヤーの残高以下であることを検証する
5. WHEN 全プレイヤーがベットを配置する THEN THE System SHALL ゲームを開始しカードを配布する
6. WHEN プレイヤーが通常勝利する THEN THE System SHALL ベット額の1:1（等倍）の配当を支払う
7. WHEN プレイヤーがブラックジャックで勝利する THEN THE System SHALL ベット額の3:2（1.5倍）の配当を支払う
8. WHEN プレイヤーが引き分け（プッシュ）になる THEN THE System SHALL ベット額をプレイヤーに返却する
9. WHEN プレイヤーが敗北する THEN THE System SHALL ベット額を没収する
10. WHEN ゲームが終了する THEN THE System SHALL 各プレイヤーの更新された残高を表示する
11. WHEN プレイヤーの残高が$1未満になる THEN THE System SHALL プレイヤーに残高不足を通知し、残高を$1,000にリセットするオプションを提供する
12. THE System SHALL 各プレイヤーの現在の残高とベット額を常に画面に表示する