# 実装計画: ブラックジャックマルチプレイヤーゲーム

## 概要

WebSocketを使用したリアルタイム通信によるマルチプレイヤーブラックジャックゲームの実装。サーバーサイドでゲーム状態を権威的に管理し、複数のルームで並行してゲームを進行できるシステムを構築します。

## タスク

- [x] 1. プロジェクト構造とコア設定の初期化
  - Node.js プロジェクトの初期化とパッケージ依存関係の設定
  - Express サーバーと Socket.IO の基本設定
  - プロジェクトディレクトリ構造の作成
  - _要件: 全体的なシステム基盤_

- [x] 2. データモデルとゲームロジックの実装
  - [x] 2.1 カードとデックのデータモデル実装
    - Card クラスとDeck クラスの作成
    - カードシャッフル機能とカード配布機能の実装
    - _要件: 6.2, 8.1_

  - [x] 2.2 カードとデックのプロパティテスト作成

    - **プロパティ 16: サーバーサイドデック管理**
    - **検証対象: 要件 8.1**

  - [x] 2.3 プレイヤーとゲーム状態のデータモデル実装
    - Player クラス、GameState クラス、Room クラスの作成
    - 手札値計算機能（エース処理含む）の実装
    - _要件: 6.4, 1.2_

  - [x] 2.4 エース値計算のプロパティテスト作成

    - **プロパティ 14: エース値の最適計算**
    - **検証対象: 要件 6.4**

- [x] 3. ゲームエンジンとルーム管理の実装
  - [x] 3.1 RoomManager クラスの実装
    - ルーム作成、プレイヤー参加/退出機能
    - 複数ルームの独立管理機能
    - _要件: 4.1, 4.3, 4.4_

  - [x] 3.2 ルーム管理のプロパティテスト作成

    - **プロパティ 9: ルーム独立性**
    - **プロパティ 10: 重複参加防止**
    - **検証対象: 要件 4.3, 4.4**

  - [x] 3.3 GameEngine クラスの実装
    - プレイヤーアクション処理（ヒット、スタンド）
    - ターン管理とゲーム状態更新機能
    - _要件: 6.2, 6.3, 8.2_

  - [x] 3.4 プレイヤーアクション処理のプロパティテスト作成

    - **プロパティ 13: プレイヤーアクション処理**
    - **プロパティ 17: アクション検証**
    - **検証対象: 要件 6.2, 6.3, 8.2**

- [ ] 4. ディーラーAIとゲーム判定の実装
  - [x] 4.1 DealerAI クラスの実装
    - ディーラーの自動判定ロジック（16以下でヒット、17以上でスタンド）
    - ディーラーターンの自動実行機能
    - _要件: 3.1, 3.2, 3.3_

  - [x] 4.2 ディーラーAIのプロパティテスト作成

    - **プロパティ 6: ディーラーAIの判定ロジック**
    - **プロパティ 7: ディーラーターン開始条件**
    - **検証対象: 要件 3.1, 3.2, 3.3**

  - [x] 4.3 勝敗判定とバスト処理の実装
    - ブラックジャック標準ルールに基づく勝敗判定
    - バスト判定とゲーム終了処理
    - _要件: 6.1, 6.5, 3.4_

  - [x] 4.4 勝敗判定のプロパティテスト作成

    - **プロパティ 8: 勝敗判定と結果通知**
    - **プロパティ 12: バスト判定処理**
    - **検証対象: 要件 6.1, 6.5, 3.4**

- [x] 5. チェックポイント - コアゲームロジックの検証
  - 全てのテストが通ることを確認し、質問があれば用户に確認する

- [x] 6. WebSocket通信とリアルタイム機能の実装
  - [x] 6.1 WebSocketHandler クラスの実装
    - Socket.IO イベントハンドラーの設定
    - プレイヤー参加/退出の通信処理
    - _要件: 1.2, 1.3, 1.4_

  - [x] 6.2 プレイヤー参加処理のプロパティテスト作成


    - **プロパティ 1: プレイヤー参加処理の完全性**
    - **プロパティ 2: 接続切断時の除外処理**
    - **検証対象: 要件 1.2, 1.3, 1.4**

  - [x] 6.3 ゲーム状態同期とリアルタイム更新の実装
    - 全クライアントへの状態ブロードキャスト機能
    - 接続切断時の自動再接続処理
    - _要件: 5.3, 8.4_

  - [x] 6.4 状態同期のプロパティテスト作成

    - **プロパティ 11: 自動再接続と状態同期**
    - **プロパティ 18: 状態同期保証**
    - **検証対象: 要件 5.3, 8.4**

- [x] 7. クライアントサイドUIの実装
  - [x] 7.1 基本HTML構造とCSS スタイリングの作成
    - ルーム選択画面とゲーム画面のHTML
    - レスポンシブデザインのCSS実装
    - _要件: 7.1, 7.5_

  - [x] 7.2 GameUI クラスとSocket クライアントの実装
    - ゲーム状態の表示更新機能
    - プレイヤーアクションボタンの制御
    - _要件: 7.2, 7.3_

  - [x] 7.3 UI表示のプロパティテスト作成

    - **プロパティ 15: ターン表示の正確性**
    - **検証対象: 要件 7.2, 7.3**

  - [x] 7.3 WebSocket クライアント通信の実装
    - サーバーとのリアルタイム通信処理
    - エラーハンドリングと再接続機能
    - _要件: 5.4_

- [-] 8. ゲーム開始制御とフロー管理の実装
  - [x] 8.1 ゲーム開始条件とカード配布の実装
    - 参加者数に基づくゲーム開始ボタン制御
    - ゲーム開始時の初期カード配布処理
    - _要件: 2.1, 2.2, 2.3_

  - [x] 8.2 ゲーム開始制御のプロパティテスト作成

    - **プロパティ 3: ゲーム開始条件の制御**
    - **プロパティ 4: ゲーム開始時のカード配布**
    - **検証対象: 要件 2.1, 2.3**

  - [x] 8.3 ゲーム進行中の参加制限とゲーム終了処理の実装
    - ゲーム中の新規参加防止機能
    - ゲーム終了後の待機時間とリセット処理
    - _要件: 2.4, 3.5_

  - [ ]* 8.4 ゲーム制限のプロパティテスト作成
    - **プロパティ 5: ゲーム中の参加制限**
    - **検証対象: 要件 2.4**

- [-] 9. エラーハンドリングとセキュリティの実装
  - [x] 9.1 通信エラーハンドリングの実装
    - WebSocket接続エラーの処理
    - 適切なエラーメッセージとユーザー通知
    - _要件: 5.4_

  - [x] 9.2 ゲームロジックの検証とセキュリティ強化
    - サーバーサイドでのアクション検証強化
    - 同時アクション競合の解決処理
    - _要件: 8.3_

  - [ ]* 9.3 セキュリティのプロパティテスト作成
    - **プロパティ 17: アクション検証**
    - **検証対象: 要件 8.2**

- [x] 10. 統合とシステムテスト
  - [x] 10.1 全コンポーネントの統合
    - サーバーとクライアントの完全な接続
    - 全機能の統合テスト実行
    - _要件: 全体統合_

  - [x] 10.2 統合テストの作成

    - エンドツーエンドのゲームフロー検証
    - 複数プレイヤーでの同時接続テスト
    - _要件: 全体統合_

- [x] 11. 最終チェックポイント - 全機能の検証
  - 全てのテストが通ることを確認し、質問があれば用户に確認する

- [-] 12. ベッティングシステムの実装
  - [x] 12.1 BettingManager クラスの実装
    - 初期残高付与機能の実装
    - ベット検証ロジック（最小額、残高チェック）の実装
    - 有効チップ額組み合わせ検証の実装
    - 配当計算機能の実装
    - _要件: 9.1, 9.3, 9.4, 9.6, 9.7, 9.8, 9.9_

  - [x] 12.2 ベット検証のプロパティテスト作成

    - **プロパティ 19: 初期残高付与**
    - **プロパティ 20: ベット額検証**
    - **プロパティ 21: 有効チップ額組み合わせ検証**
    - **検証対象: 要件 9.1, 9.3, 9.4**

  - [x] 12.3 配当計算のプロパティテスト作成

    - **プロパティ 22: 配当計算の正確性**
    - **検証対象: 要件 9.6, 9.7, 9.8, 9.9**

  - [x] 12.4 ゲームエンジンへのベッティング統合
    - ゲーム開始前のベッティングフェーズ追加
    - 全プレイヤーベット後のゲーム開始制御
    - ゲーム終了時の配当処理と残高更新
    - _要件: 9.5, 9.10_

  - [x] 12.5 ベッティングフローのプロパティテスト作成

    - **プロパティ 23: 全員ベット後のゲーム開始**
    - **プロパティ 24: 残高更新の正確性**
    - **検証対象: 要件 9.5, 9.10**

- [ ] 13. ベッティングUIの実装
  - [x] 13.1 ベッティングインターフェースのHTML/CSS作成
    - チップ選択ボタンの実装
    - 残高とベット額表示エリアの作成
    - ベット配置ボタンとクリアボタンの実装
    - _要件: 9.2, 9.12_

  - [x] 13.2 クライアントサイドベッティングロジックの実装
    - チップ選択とベット額計算機能
    - ベット配置の送信処理
    - 残高表示の更新処理
    - _要件: 9.2, 9.12_

  - [x] 13.3 配当結果表示の実装
    - ゲーム終了時の配当結果表示
    - 更新された残高の表示
    - 残高不足時の通知とリセットオプション
    - _要件: 9.10, 9.11_

  - [x] 13.4 ベッティングUIの単体テスト作成

    - チップ選択機能のテスト
    - ベット額計算のテスト
    - 残高表示更新のテスト
    - _要件: 9.2, 9.12_

- [ ] 14. WebSocket通信のベッティング対応
  - [x] 14.1 ベッティング関連イベントハンドラーの追加
    - place-bet イベントハンドラーの実装
    - betting-phase イベントの送信処理
    - payout-result イベントの送信処理
    - _要件: 9.2, 9.10_

  - [x] 14.2 クライアント側ベッティングイベントリスナーの実装
    - betting-phase イベントリスナー
    - bet-placed イベントリスナー
    - payout-result イベントリスナー
    - balance-updated イベントリスナー
    - _要件: 9.2, 9.10_

  - [x] 14.3 ベッティング通信の統合テスト作成

    - ベット配置から配当受取までのエンドツーエンドテスト
    - 複数プレイヤーの同時ベット処理テスト
    - _要件: 9.5, 9.10_

- [x] 15. ベッティングシステムのチェックポイント
  - 全てのベッティング関連テストが通ることを確認し、質問があれば用户に確認する

## 注意事項

- `*` マークの付いたタスクはオプションで、より迅速なMVP開発のためにスキップ可能
- 各タスクは特定の要件への追跡可能性のため要件番号を参照
- チェックポイントは段階的な検証を保証
- プロパティテストは普遍的な正確性プロパティを検証
- 単体テストは特定の例とエッジケースを検証